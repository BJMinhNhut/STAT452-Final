---
title: "STAT452 Final Project"
author: "Luu Quoc Bao - 22125008, Le Minh Hoang - 22125029, Le Duc Nhuan - 22125070,
  Dang Minh Nhut - 22125071"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Library

```{r}
library(ggplot2)
library(readxl)
library(car)
library(faraway)
library(corrplot)
library(dplyr)
```

## Activity 1

```{r}
set.seed(452)
```

### 1.1 Load and clean data

```{r}
df <- read.csv("Fish.csv", header = TRUE)
head(df)
# Đọc dữ liệu
df <- read.csv("Fish.csv", header = TRUE)

# Chuyển đổi biến định tính 'Species' thành các biến giả nhưng bỏ đi một cột để tránh dư thừa
df_encoded <- model.matrix(~Species, data=df)[, -1]
df_encoded <- as.data.frame(df_encoded)

# Ghép cột mã hóa với các cột còn lại trong dữ liệu
df_final <- cbind(df_encoded, df[, -1])

# Xem dữ liệu sau khi biến đổi
head(df_final)
```

```{r}
dim(df)
```

```{r}
sum(duplicated(df))
```

#### Remove car names

```{r}
boxplot(df$Weight ~ df$Species,
        main="Boxplot of Fish Weights by Species",
        xlab="Species",
        ylab="Weight",
        col="lightblue")
```

#### Histograms

```{r}
par(mfrow = c(2, 4))
for (col in names(df)) {
  if (is.numeric(df[[col]]))
    hist(df[[col]], main = paste("Histogram of", col), xlab = col, breaks = 30)
}
par(mfrow = c(1, 1))
```

#### Log Histogram

```{r}
par(mfrow = c(2, 4))
for (col in names(df)) {
  if (is.numeric(df[[col]]))
    hist(log(df[[col]]), main = paste("Histogram of", col), xlab = col, breaks = 30)
}
par(mfrow = c(1, 1))
```


#### Boxplots & remove outliers

```{r}
par(mfrow = c(2, 4))

for (col in names(df)) {
  if (is.numeric(df[[col]]))
    boxplot(df[col], main = col)
}

par(mfrow = c(1, 1))
```

```{r}
# Function to remove outliers using IQR for a single column
identify_outliers_IQR <- function(x) {
  Q1 <- quantile(x, 0.25)
  Q3 <- quantile(x, 0.75)
  IQR <- Q3 - Q1
  lower_bound <- Q1 - 1.5 * IQR
  upper_bound <- Q3 + 1.5 * IQR
  !(x >= lower_bound & x <= upper_bound)
}

# Identify outliers for each numeric column
outlier_matrix <- df %>%
  select(where(is.numeric)) %>%
  mutate(across(everything(), identify_outliers_IQR))

# Filter out rows with any outlier
df_clean <- df[!apply(outlier_matrix, 1, any), ]

dim(df_clean)
```

```{r}
par(mfrow = c(2, 4))

for (col in names(df_clean)) {
  if (is.numeric(df_clean[[col]]))
    boxplot(df_clean[col], main = col)
}

par(mfrow = c(1, 1))
```

### 1.2 Split data

```{r}
df = df_final
# Define the split ratio
train_ratio <- 0.8

# Determine the number of rows in the training set
train_size <- floor(train_ratio * nrow(df))

# Randomly sample row indices for the training set
train_indices <- sample(seq_len(nrow(df)), size = train_size)

# Split the data into training and testing sets
train_set <- df[train_indices, ]
test_set <- df[-train_indices, ]

# Display the number of rows in each set
dim(train_set) # Should be approximately 80
dim(test_set)  # Should be approximately 20
train_set
```

### 1.3 Model

#### Collinearity

```{r}
pairs(subset(df, select = - c(origin_id)))
```

```{r}
corrplot(cor(subset(df_clean, select = -origin_id)), method = "number")
```

```{r}
corrplot(cor(log(subset(df_clean, select = -origin_id))), method = "number")
```

```{r}
model_full <- lm(Weight ~ ., data = train_set)
summary(model_full)
```

```{r}
car::vif(model_full)
```

```{r}
model_bw <- step(model_full, data = train_set, direction = "both")
```

```{r}
summary(model_bw)
```

```{r}
model <- model_bw
summary(model)
```

#### Evaluate the model
```{r}
# Dự đoán trên tập test với mô hình tối ưu
predictions <- predict(model, newdata = test_set)

# Tính toán các chỉ số đánh giá
mse <- mean((test_set$Weight - predictions)^2)
r_squared <- 1 - (sum((test_set$Weight - predictions)^2) / sum((test_set$Weight - mean(test_set$Weight))^2))

# In ra các chỉ số
cat("MSE:", mse, "\n")
cat("R-squared:", r_squared, "\n")

```

```{r}
predictions <- predict(model, newdata = test_set) 
# Actual values from the test set 
actual_values <- test_set$Weight
# Calculate Mean Squared Error (MSE) 
mse <- mean((predictions - actual_values)^2)  
# Calculate R-squared 
rss <- sum((predictions - actual_values)^2) 
tss <- sum((actual_values - mean(actual_values))^2) 
r_squared <- 1 - (rss / tss)  
# Print metrics cat("Mean Squared Error (MSE):", mse, "\n") 
cat("R-squared:", r_squared, "\n")
```

#### Validating residuals

```{r}
e <- predictions - actual_values
hist(e, main = "Histogram of Residuals", xlab = "Residuals", breaks = 30)
```

```{r}
qqnorm(e)
qqline(e, col = "red")
```

```{r}
shapiro.test(e)
```

## Activity 2